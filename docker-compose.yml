version: '3.7'

networks:
  traefik:
    external:
      name: traefik
  blog_tp_backend: ~

volumes:
  wp-data: ~
  composer-cache: ~

services:
  db:
    image: mysql:5.7
    container_name: tpblog_db
    volumes:
      - ./data/db:/var/lib/mysql/
      - ./data/mysql_init:/docker-entrypoint-initdb.d
    env_file:
      - .env
    ports:
      - "3306:3306"
    networks:
      - blog_tp_backend

  wp:
    build:
      context: data/docker/wordpress
    image: tp-wordpress:1.0
    container_name: tpblog_wp
    entrypoint: bash -c '/app/build.sh && /app/start.sh'
    env_file:
      - .env
    volumes:
      - composer-cache:/root/.composer
      - ./app:/app/wp:cached
    depends_on:
      - db
    labels:
      - "traefik.enable=true"
      - "traefik.frontend.rule=Host:blog.talentplatforms.localhost"
      - "traefik.port=80"
      - "traefik.docker.network=traefik"
      - "traefik.backend=blog_tp"
      - "traefik.frontend.entryPoints=http,https"
    networks:
      - blog_tp_backend
      - traefik

  # webpack:
  #   build:
  #     context: data/docker/webpack
  #   container_name: tpblog_webpack
  #   depends_on:
  #     - wp
  #   restart: always
  #   # volumes:
  #     # - ./data/tpde-theme:/home/node/app
  #   environment:
  #     NODE_ENV: development
